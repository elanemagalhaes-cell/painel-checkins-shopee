<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Check-in â€” Shopee</title>
  <meta name="description" content="Painel de Check-in em tempo quase real, lendo a view v_painel_drivers no Supabase.">
  <style>
    :root{
      --bg:#fff9f5; --card:#ffe8d9; --card-2:#fff3ea; --text:#5a3a2f;
      --text-soft:#7d6158; --border:#f2cdb7; --accent:#ff8a4c; --accent-2:#fbd2bd;
      --muted:#9e8e88; --check:#f0fff2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:26px}
    .sub{color:var(--text-soft);font-size:14px;margin-bottom:14px}
    .card{background:linear-gradient(180deg,var(--card) 0,var(--card-2) 100%);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:14px}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
    .pill{background:#fff;border:1px solid var(--border);border-radius:999px;padding:10px 12px;display:flex;gap:10px;align-items:center;flex:1 1 480px}
    .pill input{width:100%;border:none;outline:none;font-size:16px;background:transparent;color:var(--text)}
    .meta{margin-left:auto;color:var(--text-soft);font-size:12px}
    .err{margin:8px 0;padding:10px 12px;border-radius:12px;background:#fff1f0;color:#9c2f2f;border:1px solid #ffd3cf;display:none}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{text-align:left;font-size:13px;color:#6b4b42;letter-spacing:.02em;background:#ffe1cd;position:sticky;top:0;z-index:1;padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px;border-bottom:1px solid #f5e3d9;font-size:14px}
    tbody tr:nth-child(even){background:#fffdfa}
    .hit{background:var(--check)}
    .badge{display:inline-block;min-width:28px;text-align:center;font-weight:700;background:var(--accent-2);color:#7a4a38;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:13px}
    .muted{color:var(--muted)}
    .highlight{outline:2px solid #ffb089;transition:outline-color .6s}
    .footer{display:flex;justify-content:space-between;align-items:center;color:var(--text-soft);font-size:12px;margin-top:10px;gap:12px;flex-wrap:wrap}
    @media (max-width:680px){.pill{flex:1 1 100%}.meta{width:100%;margin-left:0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>ðŸ“‹ Painel de Drivers</h1>
      <div class="sub">Dados em tempo quase real a partir da view <code>v_painel_drivers</code> (Supabase). Ordenado por <strong>Corridor/Cage</strong>; <strong>Ordem</strong> = sequÃªncia de chegada.</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <label class="pill" title="Consultar posiÃ§Ã£o: digite ID do driver ou nome">
          <span class="muted">Filtrar:</span>
          <input id="q" placeholder="Digite ID do driver (ex.: 1450869) ou nome" />
        </label>
        <div id="last" class="meta">â€”</div>
      </div>

      <div id="err" class="err"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px">Driver ID</th>
              <th>Driver</th>
              <th style="width:160px">Corridor/Cage</th>
              <th style="width:110px">Hora</th>
              <th style="width:110px">Check-in</th>
              <th style="width:110px">Ordem</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>

      <div class="footer">
        <div class="muted">Projeto Check-in â€¢ Painel estÃ¡tico (GitHub/Pages) â€¢ Supabase REST</div>
        <div id="count" class="muted">â€”</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ðŸ”§ SubstituÃ­do com os dados enviados por vocÃª
    const SUPABASE_URL  = "https://jnubttskgcdguoroyyzy.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpudWJ0dHNrZ2NkZ3Vvcm95eXp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzMwNjcsImV4cCI6MjA3NjIwOTA2N30.dYZQl97-MvDRaqkSNLugY6fXrK92MiwmsGo7e89uVsk";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: false } });

    const $ = s => document.querySelector(s);
    const tb = $('#tb'), errBox = $('#err'), last = $('#last'), count = $('#count'), q = $('#q');

    const normId = s => String(s||'').replace(/\D+/g,'');
    let fullData = [];

    function render(rows){
      tb.innerHTML = '';
      let total = 0, comCheck = 0;
      for(const r of rows){
        total++; if(r.has_check) comCheck++;
        const tr = document.createElement('tr');
        if(r.has_check) tr.classList.add('hit');

        tr.innerHTML = \`
          <td>\${r.id_driver||''}</td>
          <td>\${r.driver||''}</td>
          <td>\${r.corridor||''}</td>
          <td>\${r.hora ?? '-'}</td>
          <td>\${r.has_check ? 'âœ…' : 'â€”'}</td>
          <td>\${r.ordem != null ? '<span class="badge">'+r.ordem+'</span>' : 'â€”'}</td>
        \`;

        tb.appendChild(tr);
      }
      count.textContent = \`Linhas: \${total}\` + (total? \` â€¢ Com check-in: \${comCheck}\` : '');
      last.textContent = 'Ãšltima atualizaÃ§Ã£o: ' + new Date().toLocaleString('pt-BR',{hour12:false});
    }

    async function fetchData(){
      const { data, error } = await supabase
        .from('v_painel_drivers')
        .select('id_driver, driver, corridor, has_check, hora, ordem')
        .order('corridor', { ascending: true })
        .order('has_check', { ascending: false })
        .order('ordem', { ascending: true });

      if(error){
        errBox.textContent = 'Erro: ' + (error.message || 'Falha ao buscar dados');
        errBox.style.display = 'block';
        return;
      }
      errBox.style.display = 'none';
      fullData = data || [];
      applyFilter();
    }

    function applyFilter(){
      const f = (q.value || '').toLowerCase().trim();
      if(!f){ render(fullData); return; }
      const filtered = fullData.filter(r =>
        (r.id_driver || '').toLowerCase().includes(f) ||
        (r.driver || '').toLowerCase().includes(f) ||
        (r.corridor || '').toLowerCase().includes(f)
      );
      render(filtered);
    }

    q.addEventListener('input', () => { applyFilter(); });

    // primeira carga + polling
    fetchData();
    setInterval(fetchData, 25000);
  </script>
</body>
</html>
